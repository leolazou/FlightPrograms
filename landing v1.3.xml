<?xml version="1.0" encoding="utf-8"?>
<Program name="landing v1.3">
  <Variables>
    <Variable name="©" number="-0" />
    <Variable name="craft_height" number="-0" />
    <Variable name="max_TWR" number="-0" />
  </Variables>
  <Instructions>
    <Event event="FlightStart" id="0" style="flight-start" pos="-10,-20" />
    <WaitUntil id="1" style="wait-until">
      <Comparison op="g" style="op-gt">
        <CraftProperty property="Input.Slider1" style="prop-input" />
        <Constant text="0.5" />
      </Comparison>
    </WaitUntil>
    <WaitUntil id="2" style="wait-until">
      <Comparison op="l" style="op-lt">
        <CraftProperty property="Vel.VerticalSurfaceVelocity" style="prop-velocity" />
        <Constant number="-0" />
      </Comparison>
    </WaitUntil>
    <For var="i" id="3" style="for">
      <Constant number="1" />
      <Constant text="3" />
      <Constant text="1" />
      <Instructions>
        <Comment id="4" style="comment">
          <Constant style="comment-text" canReplace="false" text="Program start signal" />
        </Comment>
        <SetCraftProperty property="Sound.Beep" id="5" style="play-beep">
          <Constant text="2000" />
          <Constant number="1" />
          <Constant text="0.05" />
        </SetCraftProperty>
        <WaitSeconds id="6" style="wait-seconds">
          <Constant text="0.1" />
        </WaitSeconds>
      </Instructions>
    </For>
    <BroadcastMessage local="false" id="7" style="broadcast-msg-craft">
      <Constant text="chk will crash" />
      <Constant number="-0" />
    </BroadcastMessage>
    <While id="8" style="while">
      <Comparison op="g" style="op-gt">
        <BinaryOp op="+" style="op-add">
          <CallCustomExpression call="h" style="call-custom-expression" />
          <BinaryOp op="*" style="op-mul">
            <Constant text="1" />
            <CraftProperty property="Vel.VerticalSurfaceVelocity" style="prop-velocity" />
          </BinaryOp>
        </BinaryOp>
        <CallCustomExpression call="h_to_stop" style="call-custom-expression" />
      </Comparison>
      <Instructions>
        <LockNavSphere indicatorType="Retrograde" id="9" style="lock-nav-sphere" />
        <SetInput input="throttle" id="10" style="set-input">
          <CallCustomExpression call="descent_throttle" style="call-custom-expression" />
        </SetInput>
        <SetVariable id="11" style="set-variable">
          <Variable list="false" local="false" variableName="©" />
          <StringOp op="join" style="join">
            <Constant text="{∆h =" />
            <StringOp op="friendly" subOp="distance" style="friendly">
              <BinaryOp op="-" style="op-sub">
                <CallCustomExpression call="h" style="call-custom-expression" />
                <CallCustomExpression call="h_to_stop" style="call-custom-expression" />
              </BinaryOp>
            </StringOp>
            <Constant text="}" />
            <Constant text="" />
          </StringOp>
        </SetVariable>
        <SetVariable id="12" style="set-variable">
          <Variable list="false" local="false" variableName="©" />
          <StringOp op="join" style="join">
            <Variable list="false" local="false" variableName="©" />
            <Constant text="-" />
            <Constant text="{tt stop =" />
            <StringOp op="friendly" subOp="time" style="friendly">
              <CallCustomExpression call="t_to_stop" style="call-custom-expression" />
            </StringOp>
            <Constant text="}" />
            <Constant text="" />
          </StringOp>
        </SetVariable>
        <SetVariable id="13" style="set-variable">
          <Variable list="false" local="false" variableName="©" />
          <StringOp op="join" style="join">
            <Variable list="false" local="false" variableName="©" />
            <Constant text="-" />
            <Constant text="{∆tt =" />
            <StringOp op="friendly" subOp="time" style="friendly">
              <BinaryOp op="-" style="op-sub">
                <CallCustomExpression call="t_to_impact" style="call-custom-expression" />
                <CallCustomExpression call="t_to_stop" style="call-custom-expression" />
              </BinaryOp>
            </StringOp>
            <Constant text="}" />
            <Constant text="" />
          </StringOp>
        </SetVariable>
        <SetVariable id="14" style="set-variable">
          <Variable list="false" local="false" variableName="©" />
          <StringOp op="join" style="join">
            <Variable list="false" local="false" variableName="©" />
            <Constant text="-" />
            <Constant text="{side v =" />
            <StringOp op="friendly" subOp="velocity" style="friendly">
              <CraftProperty property="Vel.LateralSurfaceVelocity" style="prop-velocity" />
            </StringOp>
            <Constant text="}" />
            <Constant text="" />
          </StringOp>
        </SetVariable>
        <DisplayMessage id="15" style="display">
          <Variable list="false" local="false" variableName="©" />
          <Constant number="7" />
        </DisplayMessage>
      </Instructions>
    </While>
    <Comment id="16" style="comment">
      <Constant style="comment-text" canReplace="false" text="Landing desceleration" />
    </Comment>
    <SetCraftProperty property="Sound.Beep" id="17" style="play-beep">
      <Constant text="700" />
      <Constant text="1" />
      <Constant text="0.7" />
    </SetCraftProperty>
    <BroadcastMessage local="false" id="18" style="broadcast-msg-craft">
      <Constant text="landing gear ready" />
      <Constant number="-0" />
    </BroadcastMessage>
    <While id="19" style="while">
      <Comparison op="g" style="op-gt">
        <CallCustomExpression call="t_to_stop" style="call-custom-expression" />
        <Constant text="0.2" />
      </Comparison>
      <Instructions>
        <LockNavSphere indicatorType="Retrograde" id="20" style="lock-nav-sphere" />
        <SetInput input="throttle" id="21" style="set-input">
          <BinaryOp op="/" style="op-div">
            <CallCustomExpression call="landing_thrust" style="call-custom-expression" />
            <CraftProperty property="Performance.MaxActiveEngineThrust" style="prop-performance" />
          </BinaryOp>
        </SetInput>
        <SetVariable id="22" style="set-variable">
          <Variable list="false" local="false" variableName="©" />
          <StringOp op="join" style="join">
            <Constant text="{∆h =" />
            <StringOp op="friendly" subOp="distance" style="friendly">
              <BinaryOp op="-" style="op-sub">
                <CallCustomExpression call="h" style="call-custom-expression" />
                <CallCustomExpression call="h_to_stop" style="call-custom-expression" />
              </BinaryOp>
            </StringOp>
            <Constant text="}" />
            <Constant text="" />
          </StringOp>
        </SetVariable>
        <SetVariable id="23" style="set-variable">
          <Variable list="false" local="false" variableName="©" />
          <StringOp op="join" style="join">
            <Variable list="false" local="false" variableName="©" />
            <Constant text="-" />
            <Constant text="{tt stop =" />
            <StringOp op="format" style="format">
              <Constant text="{0:n1}" />
              <CallCustomExpression call="t_to_stop" style="call-custom-expression" />
              <Constant text="" />
            </StringOp>
            <Constant text="s}" />
            <Constant text="" />
          </StringOp>
        </SetVariable>
        <SetVariable id="24" style="set-variable">
          <Variable list="false" local="false" variableName="©" />
          <StringOp op="join" style="join">
            <Variable list="false" local="false" variableName="©" />
            <Constant text="-" />
            <Constant text="{∆tt =" />
            <StringOp op="format" style="format">
              <Constant text="{0:n1}" />
              <BinaryOp op="-" style="op-sub">
                <CallCustomExpression call="t_to_impact" style="call-custom-expression" />
                <CallCustomExpression call="t_to_stop" style="call-custom-expression" />
              </BinaryOp>
              <Constant text="" />
            </StringOp>
            <Constant text="s}" />
            <Constant text="" />
          </StringOp>
        </SetVariable>
        <SetVariable id="25" style="set-variable">
          <Variable list="false" local="false" variableName="©" />
          <StringOp op="join" style="join">
            <Variable list="false" local="false" variableName="©" />
            <Constant text="-" />
            <Constant text="{side v =" />
            <StringOp op="friendly" subOp="velocity" style="friendly">
              <CraftProperty property="Vel.LateralSurfaceVelocity" style="prop-velocity" />
            </StringOp>
            <Constant text="}" />
            <Constant text="" />
          </StringOp>
        </SetVariable>
        <DisplayMessage id="26" style="display">
          <Variable list="false" local="false" variableName="©" />
          <Constant number="7" />
        </DisplayMessage>
      </Instructions>
    </While>
    <SetInput input="throttle" id="27" style="set-input">
      <Constant number="-0" />
    </SetInput>
    <SetCraftProperty property="Sound.Beep" id="28" style="play-beep">
      <Constant text="440" />
      <Constant number="1" />
      <Constant number="2" />
    </SetCraftProperty>
    <DisplayMessage id="29" style="display">
      <Constant text="Landed, probably" />
      <Constant number="7" />
    </DisplayMessage>
  </Instructions>
  <Instructions>
    <Event event="ReceiveMessage" id="30" style="receive-msg" pos="1047.447,-1581.04">
      <Constant canReplace="false" text="landing gear ready" />
    </Event>
    <WaitUntil id="31" style="wait-until">
      <Comparison op="le" style="op-lte">
        <CallCustomExpression call="t_to_stop" style="call-custom-expression" />
        <Constant text="7" />
      </Comparison>
    </WaitUntil>
    <Comment id="32" style="comment">
      <Constant style="comment-text" canReplace="false" text="Deploy landing gear" />
    </Comment>
    <SetActivationGroup id="33" style="set-ag">
      <Constant text="8" />
      <Constant style="true" bool="true" />
    </SetActivationGroup>
  </Instructions>
  <Instructions>
    <Event event="ReceiveMessage" id="34" style="receive-msg" pos="1047.16,-1878.265">
      <Constant canReplace="false" text="chk will crash" />
    </Event>
    <While id="35" style="while">
      <Not style="op-not">
        <CraftProperty property="Misc.Grounded" style="prop-misc" />
      </Not>
      <Instructions>
        <If id="36" style="if">
          <Comparison op="l" style="op-lt">
            <CallCustomExpression call="h" style="call-custom-expression" />
            <CallCustomExpression call="h_to_stop" style="call-custom-expression" />
          </Comparison>
          <Instructions>
            <For var="i" id="37" style="for">
              <Constant number="1" />
              <Constant text="5" />
              <Constant text="1" />
              <Instructions>
                <SetCraftProperty property="Sound.Beep" id="38" style="play-beep">
                  <Constant text="2000" />
                  <Constant number="1" />
                  <Constant text="0.05" />
                </SetCraftProperty>
                <WaitSeconds id="39" style="wait-seconds">
                  <Constant text="0.1" />
                </WaitSeconds>
              </Instructions>
            </For>
          </Instructions>
        </If>
      </Instructions>
    </While>
  </Instructions>
  <Instructions>
    <Event event="FlightStart" id="40" style="flight-start" pos="-372.457,263.2676" />
    <SetVariable id="41" style="set-variable">
      <Variable list="false" local="false" variableName="craft_height" />
      <CraftProperty property="Altitude.AGL" style="prop-altitude" />
    </SetVariable>
    <SetVariable id="42" style="set-variable">
      <Variable list="false" local="false" variableName="max_TWR" />
      <Constant text="8" />
    </SetVariable>
  </Instructions>
  <Expressions>
    <CustomExpression callFormat="t_to_stop" format="t_to_stop return (0)" name="t_to_stop" style="custom-expression" pos="1041.792,-208.2937">
      <BinaryOp op="/" style="op-div">
        <MathFunction function="abs" style="op-math">
          <VectorOp op="length" style="vec-op-1">
            <CraftProperty property="Vel.SurfaceVelocity" style="prop-velocity" />
          </VectorOp>
        </MathFunction>
        <BinaryOp op="-" style="op-sub">
          <CallCustomExpression call="max_a" style="call-custom-expression" />
          <CallCustomExpression call="g" style="call-custom-expression" />
        </BinaryOp>
      </BinaryOp>
    </CustomExpression>
    <CustomExpression callFormat="t_to_impact" format="t_to_impact return (0)" name="t_to_impact" style="custom-expression" pos="1042.072,-267.4133">
      <BinaryOp op="/" style="op-div">
        <CallCustomExpression call="h" style="call-custom-expression" />
        <MathFunction function="abs" style="op-math">
          <CraftProperty property="Vel.VerticalSurfaceVelocity" style="prop-velocity" />
        </MathFunction>
      </BinaryOp>
    </CustomExpression>
    <CustomExpression callFormat="max_a" format="max_a return (0)" name="max_a" style="custom-expression" pos="1045.743,-606.0049">
      <BinaryOp op="min" style="op-min">
        <BinaryOp op="*" style="op-mul">
          <Variable list="false" local="false" variableName="max_TWR" />
          <CallCustomExpression call="g" style="call-custom-expression" />
        </BinaryOp>
        <BinaryOp op="/" style="op-div">
          <CraftProperty property="Performance.MaxActiveEngineThrust" style="prop-performance" />
          <CraftProperty property="Performance.Mass" style="prop-performance" />
        </BinaryOp>
      </BinaryOp>
    </CustomExpression>
    <CustomExpression callFormat="g" format="g return (0)" name="g" style="custom-expression" pos="1041.656,-672.1135">
      <VectorOp op="length" style="vec-op-1">
        <CraftProperty property="Vel.Gravity" style="prop-velocity" />
      </VectorOp>
    </CustomExpression>
    <CustomExpression callFormat="h" format="h return (0)" name="h" style="custom-expression" pos="1045.017,-805.9586">
      <BinaryOp op="max" style="op-max">
        <Constant number="-0" />
        <BinaryOp op="-" style="op-sub">
          <CraftProperty property="Altitude.AGL" style="prop-altitude" />
          <Variable list="false" local="false" variableName="craft_height" />
        </BinaryOp>
      </BinaryOp>
    </CustomExpression>
    <CustomExpression callFormat="h_to_stop" format="h_to_stop return (0)" name="h_to_stop" style="custom-expression" pos="1042.471,-146.4266">
      <BinaryOp op="*" style="op-mul">
        <Constant text="0.5" />
        <BinaryOp op="/" style="op-div">
          <BinaryOp op="^" style="op-exp">
            <VectorOp op="length" style="vec-op-1">
              <CraftProperty property="Vel.SurfaceVelocity" style="prop-velocity" />
            </VectorOp>
            <Constant text="2" />
          </BinaryOp>
          <BinaryOp op="-" style="op-sub">
            <CallCustomExpression call="max_a" style="call-custom-expression" />
            <CallCustomExpression call="g" style="call-custom-expression" />
          </BinaryOp>
        </BinaryOp>
      </BinaryOp>
    </CustomExpression>
    <CustomExpression callFormat="landing_thrust" format="landing_thrust return (0)" name="landing_thrust" style="custom-expression" pos="1043.564,-1028.239">
      <BinaryOp op="*" style="op-mul">
        <CraftProperty property="Performance.Mass" style="prop-performance" />
        <BinaryOp op="min" style="op-min">
          <BinaryOp op="*" style="op-mul">
            <Variable list="false" local="false" variableName="max_TWR" />
            <CallCustomExpression call="g" style="call-custom-expression" />
          </BinaryOp>
          <BinaryOp op="+" style="op-add">
            <CallCustomExpression call="g" style="call-custom-expression" />
            <BinaryOp op="*" style="op-mul">
              <Constant text="0.5" />
              <BinaryOp op="/" style="op-div">
                <BinaryOp op="^" style="op-exp">
                  <VectorOp op="length" style="vec-op-1">
                    <CraftProperty property="Vel.SurfaceVelocity" style="prop-velocity" />
                  </VectorOp>
                  <Constant text="2" />
                </BinaryOp>
                <CallCustomExpression call="h" style="call-custom-expression" />
              </BinaryOp>
            </BinaryOp>
          </BinaryOp>
        </BinaryOp>
      </BinaryOp>
    </CustomExpression>
    <CustomExpression callFormat="dv•_tgt" format="dv•_tgt return (0)" name="dv•_tgt" style="custom-expression" pos="541.7751,200.8782">
      <CraftProperty property="Part.PciToLocal" style="part-transform">
        <Constant number="-0" />
        <BinaryOp op="-" style="op-sub">
          <CraftProperty property="Craft.Velocity" style="craft">
            <Constant number="-0" />
          </CraftProperty>
          <CraftProperty property="Target.Velocity" style="prop-velocity" />
        </BinaryOp>
      </CraftProperty>
    </CustomExpression>
    <CustomExpression callFormat="dh_tgt" format="dh_tgt return (0)" name="dh_tgt" style="custom-expression" pos="541.0658,118.2402">
      <BinaryOp op="-" style="op-sub">
        <BinaryOp op="-" style="op-sub">
          <CraftProperty property="Altitude.ASL" style="prop-altitude" />
          <Variable list="false" local="false" variableName="craft_height" />
        </BinaryOp>
        <CraftProperty property="Terrain.Height" style="terrain-query">
          <Planet op="toLatLongAgl" style="planet-to-lat-long-agl">
            <CraftProperty property="Target.Position" style="prop-nav" />
          </Planet>
        </CraftProperty>
      </BinaryOp>
    </CustomExpression>
    <CustomExpression callFormat="r•_tgt" format="r•_tgt return (0)" name="r•_tgt" style="custom-expression" pos="543.3372,284.2361">
      <CraftProperty property="Part.PciToLocal" style="part-transform">
        <Constant number="-0" />
        <BinaryOp op="-" style="op-sub">
          <CraftProperty property="Target.Position" style="prop-nav" />
          <CraftProperty property="Craft.Position" style="craft">
            <Constant number="-0" />
          </CraftProperty>
        </BinaryOp>
      </CraftProperty>
    </CustomExpression>
    <CustomExpression callFormat="corr•_to_tgt" format="corr•_to_tgt return (0)" name="corr•_to_tgt" style="custom-expression" pos="542.9255,389.0263">
      <BinaryOp op="-" style="op-sub">
        <CallCustomExpression call="r•_tgt" style="call-custom-expression" />
        <BinaryOp op="*" style="op-mul">
          <CallCustomExpression call="dv•_tgt" style="call-custom-expression" />
          <BinaryOp op="/" style="op-div">
            <CallCustomExpression call="dh_tgt" style="call-custom-expression" />
            <MathFunction function="abs" style="op-math">
              <CraftProperty property="Vel.VerticalSurfaceVelocity" style="prop-velocity" />
            </MathFunction>
          </BinaryOp>
        </BinaryOp>
      </BinaryOp>
    </CustomExpression>
    <CustomExpression callFormat="descent_throttle" format="descent_throttle return (0)" name="descent_throttle" style="custom-expression" pos="1042.848,-937.8417">
      <BinaryOp op="*" style="op-mul">
        <BinaryOp op="^" style="op-exp">
          <BinaryOp op="-" style="op-sub">
            <Constant text="1" />
            <VectorOp op="dot" style="vec-op-2">
              <VectorOp op="norm" style="vec-op-1">
                <CraftProperty property="Vel.SurfaceVelocity" style="prop-velocity" />
              </VectorOp>
              <BinaryOp op="*" style="op-mul">
                <Constant text="-1" />
                <CraftProperty property="Nav.CraftDirection" style="prop-nav" />
              </BinaryOp>
            </VectorOp>
          </BinaryOp>
          <Constant text="0.33" />
        </BinaryOp>
        <BinaryOp op="min" style="op-min">
          <Constant text="1" />
          <BinaryOp op="/" style="op-div">
            <Variable list="false" local="false" variableName="max_TWR" />
            <BinaryOp op="/" style="op-div">
              <CraftProperty property="Performance.MaxActiveEngineThrust" style="prop-performance" />
              <CraftProperty property="Performance.Mass" style="prop-performance" />
            </BinaryOp>
          </BinaryOp>
        </BinaryOp>
      </BinaryOp>
    </CustomExpression>
  </Expressions>
</Program>