<?xml version="1.0" encoding="utf-8"?>
<Program name="ascend v2">
  <Variables>
    <Variable name="`Ap" number="-0" />
    <Variable name="`Pe" number="-0" />
    <Variable name="`time_to_Ap" number="-0" />
    <Variable name="`max_TWR" number="-0" />
    <Variable name="Q" number="-0" />
    <Variable name="`max_maxQ" number="-0" />
    <Variable name="`ascent_angle_power" number="-0" />
    <Variable name="auto" number="-0" />
  </Variables>
  <Instructions>
    <Event event="ReceiveMessage" id="0" style="receive-msg" pos="542.9273,-52.45521">
      <Constant canReplace="false" text="ascent staging" />
    </Event>
    <While id="1" style="while">
      <Variable list="false" local="false" variableName="auto" />
      <Instructions>
        <WaitUntil id="2" style="wait-until">
          <Comparison op="le" style="op-lte">
            <CraftProperty property="Fuel.FuelInStage" style="prop-fuel" />
            <Constant number="-0" />
          </Comparison>
        </WaitUntil>
        <WaitSeconds id="3" style="wait-seconds">
          <Constant text="1" />
        </WaitSeconds>
        <ActivateStage id="4" style="activate-stage" />
        <WaitSeconds id="5" style="wait-seconds">
          <Constant text="0.5" />
        </WaitSeconds>
      </Instructions>
    </While>
  </Instructions>
  <Instructions>
    <Event event="ReceiveMessage" id="6" style="receive-msg" pos="543.7771,-379.1028">
      <Constant canReplace="false" text="ascent guidance" />
    </Event>
    <While id="7" style="while">
      <Comparison op="l" style="op-lt">
        <CraftProperty property="Orbit.Apoapsis" style="prop-orbit" />
        <Variable list="false" local="false" variableName="`Ap" />
      </Comparison>
      <Instructions>
        <SetVariable id="8" style="set-variable">
          <Variable list="false" local="false" variableName="Q" />
          <BinaryOp op="/" style="op-div">
            <BinaryOp op="*" style="op-mul">
              <CraftProperty property="Atmosphere.AirDensity" style="prop-atmosphere" />
              <BinaryOp op="^" style="op-exp">
                <VectorOp op="length" style="vec-op-1">
                  <CraftProperty property="Vel.SurfaceVelocity" style="prop-velocity" />
                </VectorOp>
                <Constant text="2" />
              </BinaryOp>
            </BinaryOp>
            <Constant text="2" />
          </BinaryOp>
        </SetVariable>
        <CallCustomInstruction call="set ascent thrust" id="9" style="call-custom-instruction" />
        <CallCustomInstruction call="set ascent angle" id="10" style="call-custom-instruction" />
      </Instructions>
    </While>
    <SetInput input="throttle" id="11" style="set-input">
      <Constant text="0" />
    </SetInput>
    <LockNavSphere indicatorType="Prograde" id="12" style="lock-nav-sphere" />
  </Instructions>
  <Instructions>
    <CustomInstruction callFormat="set ascent angle" format="set ascent angle" name="set ascent angle" id="13" style="custom-instruction" pos="1697.592,-38.26262" />
    <SetTargetHeading property="pitch" id="14" style="set-heading">
      <CallCustomExpression call="ascent angle" style="call-custom-expression" />
    </SetTargetHeading>
  </Instructions>
  <Instructions>
    <Event event="ReceiveMessage" id="15" style="receive-msg" pos="557.1727,-983.1429">
      <Constant canReplace="false" text="circularize" />
    </Event>
    <DisplayMessage id="16" style="display">
      <Constant text="Circularization" />
      <Constant number="7" />
    </DisplayMessage>
    <LockNavSphere indicatorType="Current" id="17" style="lock-nav-sphere" />
    <While id="18" style="while">
      <Comparison op="l" style="op-lt">
        <CallCustomExpression call="Pe" style="call-custom-expression" />
        <Variable list="false" local="false" variableName="`Pe" />
      </Comparison>
      <Instructions>
        <DisplayMessage id="19" style="display">
          <StringOp op="join" style="join">
            <Constant text="Circularising. Ap_" />
            <MathFunction function="round" style="op-math">
              <CraftProperty property="Orbit.Apoapsis" style="prop-orbit" />
            </MathFunction>
            <Constant text="_ttAp_" />
            <MathFunction function="round" style="op-math">
              <CraftProperty property="Orbit.TimeToApoapsis" style="prop-orbit" />
            </MathFunction>
            <Constant text="_Pe_" />
            <MathFunction function="round" style="op-math">
              <CallCustomExpression call="Pe" style="call-custom-expression" />
            </MathFunction>
            <Constant text="" />
          </StringOp>
          <Constant number="7" />
        </DisplayMessage>
        <SetTargetHeading property="pitch" id="20" style="set-heading">
          <Conditional style="conditional">
            <Comparison op="g" style="op-gt">
              <CraftProperty property="Orbit.TimeToApoapsis" style="prop-orbit" />
              <CallCustomExpression call="safetime_to_Pe" style="call-custom-expression" />
            </Comparison>
            <Constant text="0" />
            <BinaryOp op="*" style="op-mul">
              <Constant text="15" />
              <BinaryOp op="-" style="op-sub">
                <Constant text="1" />
                <BinaryOp op="/" style="op-div">
                  <CraftProperty property="Orbit.TimeToApoapsis" style="prop-orbit" />
                  <CallCustomExpression call="safetime_to_Pe" style="call-custom-expression" />
                </BinaryOp>
              </BinaryOp>
            </BinaryOp>
          </Conditional>
        </SetTargetHeading>
        <If id="21" style="if">
          <Comparison op="g" style="op-gt">
            <CraftProperty property="Orbit.Periapsis" style="prop-orbit" />
            <Constant number="-0" />
          </Comparison>
          <Instructions>
            <SetInput input="throttle" id="22" style="set-input">
              <BinaryOp op="min" style="op-min">
                <CallCustomExpression call="circ thrust" style="call-custom-expression" />
                <BinaryOp op="-" style="op-sub">
                  <Constant text="1" />
                  <BinaryOp op="^" style="op-exp">
                    <BinaryOp op="/" style="op-div">
                      <CraftProperty property="Orbit.Periapsis" style="prop-orbit" />
                      <Variable list="false" local="false" variableName="`Pe" />
                    </BinaryOp>
                    <Constant text="4" />
                  </BinaryOp>
                </BinaryOp>
              </BinaryOp>
            </SetInput>
          </Instructions>
        </If>
        <ElseIf id="23" style="else">
          <Constant bool="true" />
          <Instructions>
            <SetInput input="throttle" id="24" style="set-input">
              <CallCustomExpression call="circ thrust" style="call-custom-expression" />
            </SetInput>
          </Instructions>
        </ElseIf>
      </Instructions>
    </While>
    <SetInput input="throttle" id="25" style="set-input">
      <Constant number="-0" />
    </SetInput>
    <CallCustomInstruction call="finish" id="26" style="call-custom-instruction" />
    <DisplayMessage id="27" style="display">
      <StringOp op="join" style="join">
        <Constant text="In space ! Ap_" />
        <MathFunction function="round" style="op-math">
          <CraftProperty property="Orbit.Apoapsis" style="prop-orbit" />
        </MathFunction>
        <Constant text="_Pe_" />
        <MathFunction function="round" style="op-math">
          <CallCustomExpression call="Pe" style="call-custom-expression" />
        </MathFunction>
        <Constant text="_Incl_" />
        <MathFunction function="round" style="op-math">
          <CraftProperty property="Orbit.Inclination" style="prop-orbit" />
        </MathFunction>
        <Constant text="" />
      </StringOp>
      <Constant number="7" />
    </DisplayMessage>
  </Instructions>
  <Instructions>
    <Event event="FlightStart" id="28" style="flight-start" pos="-699.5442,-68.87681" />
    <SetVariable id="29" style="set-variable">
      <Variable list="false" local="false" variableName="`Ap" />
      <BinaryOp op="*" style="op-mul">
        <Constant text="90" />
        <Constant text="1000" />
      </BinaryOp>
    </SetVariable>
    <SetVariable id="30" style="set-variable">
      <Variable list="false" local="false" variableName="`Pe" />
      <Variable list="false" local="false" variableName="`Ap" />
    </SetVariable>
    <SetVariable id="31" style="set-variable">
      <Variable list="false" local="false" variableName="`time_to_Ap" />
      <Constant text="60" />
    </SetVariable>
    <SetVariable id="32" style="set-variable">
      <Variable list="false" local="false" variableName="`max_TWR" />
      <Constant text="4" />
    </SetVariable>
    <SetVariable id="33" style="set-variable">
      <Variable list="false" local="false" variableName="`max_maxQ" />
      <Constant text="40000" />
    </SetVariable>
    <SetVariable id="34" style="set-variable">
      <Variable list="false" local="false" variableName="`ascent_angle_power" />
      <Constant text="0.5" />
    </SetVariable>
  </Instructions>
  <Instructions>
    <CustomInstruction callFormat="countdown" format="countdown" name="countdown" id="35" style="custom-instruction" pos="-178.897,-597.4568" />
    <WaitSeconds id="36" style="wait-seconds">
      <Constant number="1" />
    </WaitSeconds>
    <For id="37" style="for">
      <Constant text="5" />
      <Constant text="1" />
      <Constant text="-1" />
      <Instructions>
        <DisplayMessage id="38" style="display">
          <StringOp op="join" style="join">
            <Constant text="Countdown -" />
            <Variable list="false" local="true" variableName="i" />
            <Constant text="" />
          </StringOp>
          <Constant number="7" />
        </DisplayMessage>
        <WaitSeconds id="39" style="wait-seconds">
          <Constant number="1" />
        </WaitSeconds>
      </Instructions>
    </For>
  </Instructions>
  <Instructions>
    <CustomInstruction callFormat="ascent" format="ascent" name="ascent" id="40" style="custom-instruction" pos="-186.6571,-986.1656" />
    <LockNavSphere indicatorType="Current" id="41" style="lock-nav-sphere" />
    <SetTargetHeading property="pitch" id="42" style="set-heading">
      <Constant text="90" />
    </SetTargetHeading>
    <SetInput input="throttle" id="43" style="set-input">
      <Constant text="1" />
    </SetInput>
    <ActivateStage id="44" style="activate-stage" />
    <DisplayMessage id="45" style="display">
      <Constant text="Liftoff !" />
      <Constant number="7" />
    </DisplayMessage>
    <WaitSeconds id="46" style="wait-seconds">
      <Constant text="7" />
    </WaitSeconds>
    <BroadcastMessage local="false" id="47" style="broadcast-msg-craft">
      <Constant text="ascent display" />
      <Constant number="-0" />
    </BroadcastMessage>
    <BroadcastMessage local="false" id="48" style="broadcast-msg-craft">
      <Constant text="ascent guidance" />
      <Constant number="-0" />
    </BroadcastMessage>
    <BroadcastMessage local="false" id="49" style="broadcast-msg-craft">
      <Constant text="ascent staging" />
      <Constant number="-0" />
    </BroadcastMessage>
    <WaitUntil id="50" style="wait-until">
      <Comparison op="ge" style="op-gte">
        <CraftProperty property="Orbit.Apoapsis" style="prop-orbit" />
        <Variable list="false" local="false" variableName="`Ap" />
      </Comparison>
    </WaitUntil>
    <WaitUntil id="51" style="wait-until">
      <Comparison op="le" style="op-lte">
        <CraftProperty property="Orbit.TimeToApoapsis" style="prop-orbit" />
        <Variable list="false" local="false" variableName="`time_to_Ap" />
      </Comparison>
    </WaitUntil>
    <BroadcastMessage local="false" id="52" style="broadcast-msg-craft">
      <Constant text="circularize" />
      <Constant number="-0" />
    </BroadcastMessage>
  </Instructions>
  <Instructions>
    <Event event="FlightStart" id="53" style="flight-start" pos="-182.689,-75.34258" />
    <WaitUntil id="54" style="wait-until">
      <Comparison op="g" style="op-gt">
        <CraftProperty property="Input.Throttle" style="prop-input" />
        <Constant number="-0" />
      </Comparison>
    </WaitUntil>
    <SetVariable id="55" style="set-variable">
      <Variable list="false" local="false" variableName="auto" />
      <Constant style="true" bool="true" />
    </SetVariable>
    <CallCustomInstruction call="countdown" id="56" style="call-custom-instruction" />
    <CallCustomInstruction call="ascent" id="57" style="call-custom-instruction" />
  </Instructions>
  <Instructions>
    <Event event="ReceiveMessage" id="58" style="receive-msg" pos="562.4709,-1742.286">
      <Constant canReplace="false" text="ascent display" />
    </Event>
    <While id="59" style="while">
      <Variable list="false" local="false" variableName="auto" />
      <Instructions>
        <While id="60" style="while">
          <Comparison op="g" style="op-gt">
            <CraftProperty property="Atmosphere.AirDensity" style="prop-atmosphere" />
            <Constant text="0" />
          </Comparison>
          <Instructions>
            <DisplayMessage id="61" style="display">
              <StringOp op="join" style="join">
                <Constant text="Pitch •" />
                <MathFunction function="round" style="op-math">
                  <CraftProperty property="Nav.Pitch" style="prop-nav" />
                </MathFunction>
                <Constant text="• Q •" />
                <MathFunction function="round" style="op-math">
                  <Variable list="false" local="false" variableName="Q" />
                </MathFunction>
                <Constant text="" />
              </StringOp>
              <Constant number="7" />
            </DisplayMessage>
          </Instructions>
        </While>
      </Instructions>
    </While>
  </Instructions>
  <Instructions>
    <CustomInstruction callFormat="finish" format="finish" name="finish" id="62" style="custom-instruction" pos="-176.0892,-1690.952" />
    <LockNavSphere indicatorType="None" id="63" style="lock-nav-sphere" />
    <SetVariable id="64" style="set-variable">
      <Variable list="false" local="false" variableName="auto" />
      <Constant style="false" bool="false" />
    </SetVariable>
    <DisplayMessage id="65" style="display">
      <Constant text="Ascent finished. To manual control." />
      <Constant number="7" />
    </DisplayMessage>
  </Instructions>
  <Instructions>
    <CustomInstruction callFormat="set ascent thrust" format="set ascent thrust" name="set ascent thrust" id="66" style="custom-instruction" pos="1709.291,-386.4631" />
    <If id="67" style="if">
      <BoolOp op="or" style="op-or">
        <Comparison op="ge" style="op-gte">
          <Variable list="false" local="false" variableName="Q" />
          <Variable list="false" local="false" variableName="`max_maxQ" />
        </Comparison>
        <Comparison op="g" style="op-gt">
          <CraftProperty property="Performance.TWR" style="prop-performance" />
          <Variable list="false" local="false" variableName="`max_TWR" />
        </Comparison>
      </BoolOp>
      <Instructions>
        <SetInput input="throttle" id="68" style="set-input">
          <BinaryOp op="-" style="op-sub">
            <CraftProperty property="Input.Throttle" style="prop-input" />
            <Constant text="0.01" />
          </BinaryOp>
        </SetInput>
        <WaitSeconds id="69" style="wait-seconds">
          <Constant text="0.15" />
        </WaitSeconds>
      </Instructions>
    </If>
    <ElseIf id="70" style="else">
      <Constant bool="true" />
      <Instructions>
        <SetInput input="throttle" id="71" style="set-input">
          <BinaryOp op="min" style="op-min">
            <Constant text="1" />
            <BinaryOp op="+" style="op-add">
              <CraftProperty property="Input.Throttle" style="prop-input" />
              <Constant text="0.01" />
            </BinaryOp>
          </BinaryOp>
        </SetInput>
        <WaitSeconds id="72" style="wait-seconds">
          <Constant text="0.15" />
        </WaitSeconds>
      </Instructions>
    </ElseIf>
  </Instructions>
  <Instructions>
    <Comment id="73" style="comment" pos="1707.212,-862.9011">
      <Constant style="comment-text" canReplace="false" text="Not used for now" />
    </Comment>
  </Instructions>
  <Expressions>
    <Constant pos="470.0816,-1743.343" bool="false" />
    <BinaryOp op="^" style="op-exp" pos="2192.06,-89.93159">
      <BinaryOp op="+" style="op-add">
        <Constant text="1" />
        <BinaryOp op="^" style="op-exp">
          <BinaryOp op="/" style="op-div">
            <CraftProperty property="Orbit.Apoapsis" style="prop-orbit" />
            <Variable list="false" local="false" variableName="`Ap" />
          </BinaryOp>
          <Constant text="2" />
        </BinaryOp>
      </BinaryOp>
      <Constant text="-1" />
    </BinaryOp>
    <Constant pos="1443.49,-781.4731" text="" />
    <CustomExpression callFormat="ascent angle" format="ascent angle return (0)" name="ascent angle" style="custom-expression" pos="1698.705,-203.1044">
      <MathFunction function="rad2deg" style="op-math">
        <MathFunction function="acos" style="op-math">
          <BinaryOp op="^" style="op-exp">
            <BinaryOp op="/" style="op-div">
              <CraftProperty property="Orbit.Apoapsis" style="prop-orbit" />
              <Variable list="false" local="false" variableName="`Ap" />
            </BinaryOp>
            <Variable list="false" local="false" variableName="`ascent_angle_power" />
          </BinaryOp>
        </MathFunction>
      </MathFunction>
    </CustomExpression>
    <Constant pos="442.837,-719.1028" bool="true" />
    <CustomExpression callFormat="isnan (0) " format="isnan |value|  return (0)" name="isnan" style="custom-expression" pos="-179.8625,-2088.339">
      <BoolOp op="and" style="op-and">
        <Comparison op="=" style="op-eq">
          <StringOp op="length" style="length">
            <Variable list="false" local="true" variableName="value" />
          </StringOp>
          <Constant text="3" />
        </Comparison>
        <StringOp op="contains" style="contains">
          <Variable list="false" local="true" variableName="value" />
          <Constant text="NaN" />
        </StringOp>
      </BoolOp>
    </CustomExpression>
    <Constant pos="1624.549,-1013.066" bool="false" />
    <Constant pos="1332.579,-1013.067" number="-0" />
    <CustomExpression callFormat="ascent thrust" format="ascent thrust return (0)" name="ascent thrust" style="custom-expression" pos="1705.894,-826.0244">
      <BinaryOp op="min" style="op-min">
        <Constant text="1" />
        <BinaryOp op="/" style="op-div">
          <BinaryOp op="/" style="op-div">
            <BinaryOp op="/" style="op-div">
              <CraftProperty property="Performance.MaxActiveEngineThrust" style="prop-performance" />
              <VectorOp op="length" style="vec-op-1">
                <CraftProperty property="Vel.Gravity" style="prop-velocity" />
              </VectorOp>
            </BinaryOp>
            <CraftProperty property="Performance.Mass" style="prop-performance" />
          </BinaryOp>
          <Variable list="false" local="false" variableName="`max_TWR" />
        </BinaryOp>
      </BinaryOp>
    </CustomExpression>
    <CustomExpression callFormat="circ thrust" format="circ thrust return (0)" name="circ thrust" style="custom-expression" pos="1702.514,-1007.869">
      <Conditional style="conditional">
        <Comparison op="g" style="op-gt">
          <CraftProperty property="Orbit.TimeToApoapsis" style="prop-orbit" />
          <BinaryOp op="/" style="op-div">
            <CraftProperty property="Orbit.Period" style="prop-orbit" />
            <Constant text="2" />
          </BinaryOp>
        </Comparison>
        <Constant text="1" />
        <BinaryOp op="-" style="op-sub">
          <Constant text="1" />
          <BinaryOp op="min" style="op-min">
            <Constant text="1" />
            <BinaryOp op="^" style="op-exp">
              <BinaryOp op="/" style="op-div">
                <CraftProperty property="Orbit.TimeToApoapsis" style="prop-orbit" />
                <Variable list="false" local="false" variableName="`time_to_Ap" />
              </BinaryOp>
              <Constant text="1" />
            </BinaryOp>
          </BinaryOp>
        </BinaryOp>
      </Conditional>
    </CustomExpression>
    <CustomExpression callFormat="safetime_to_Pe" format="safetime_to_Pe return (0)" name="safetime_to_Pe" style="custom-expression" pos="-187.0105,-2422.985">
      <BinaryOp op="/" style="op-div">
        <Variable list="false" local="false" variableName="`time_to_Ap" />
        <Constant text="2" />
      </BinaryOp>
    </CustomExpression>
    <CustomExpression callFormat="Pe" format="Pe return (0)" name="Pe" style="custom-expression" pos="-182.6109,-2335.286">
      <Conditional style="conditional">
        <StringOp op="contains" style="contains">
          <CraftProperty property="Orbit.Periapsis" style="prop-orbit" />
          <Constant text="NaN" />
        </StringOp>
        <Constant number="0" />
        <CraftProperty property="Orbit.Periapsis" style="prop-orbit" />
      </Conditional>
    </CustomExpression>
    <CustomExpression callFormat="Ap" format="Ap return (0)" name="Ap" style="custom-expression" pos="-180.7823,-2252.369">
      <CraftProperty property="Orbit.Apoapsis" style="prop-orbit" />
    </CustomExpression>
    <CraftProperty property="Orbit.Apoapsis" style="prop-orbit" pos="985.7877,-1594.155" />
    <Constant pos="367.6328,-1595.143" text="" />
  </Expressions>
</Program>